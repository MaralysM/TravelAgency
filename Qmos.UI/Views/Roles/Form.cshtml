@using Microsoft.AspNetCore.Http;
@{
    @model Qmos.UI.ViewModels.RoleViewModel
    if (Model.ID_Role == 0) {
        ViewData["Title"] = "Create Role";

    }
    else {
        ViewData["Title"] = "Modify Role";

    }
    ViewData["Root"] = "Roles";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<partial name="_HeaderDetailPartial" view-data="ViewData" />

<div class="wrapper wrapper-content animated fadeInRight">
    <div class="row justify-content-md-center">
        <div class="col-lg-offset-2 col-lg-8">
            <div class="ibox ">
                <div class="ibox-content">
                    <div class="row">
                        <div class="col-lg-12">
                            @Html.ValidationSummary(false, "", new { @class = "text-danger" })
                        </div>
                        <div class="col-lg-12">
                            <form asp-action="Post" role="form" method="post">
                                <div class="form-group">
                                    <input type="hidden" asp-for="@Model.ID_Role" />
                                    <input type="hidden" asp-for="@Model.ID_Elements" />
                                    <label>Role</label>
                                    <input asp-for="@Model.TX_Role" type="text" placeholder="Role" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label>Description</label>
                                    <input asp-for="@Model.TX_Description" type="text" placeholder="Description" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label>Application</label>
                                    <select asp-for="@Model.ID_Element" as asp-items="@(new SelectList(Model.ListAplications,"Value","Text"))" class="form-control"><option value="">Select an application</option></select>
                                </div>
                                <div class="hr-line-dashed"></div>
                                <div class="form-group row text-center">
                                    <div class="col-lg-12">
                                        <a asp-action="Index" class="btn btn-white"><i class="fa fa-arrow-left"></i> Back</a>
                                        <button class="btn btn-primary" type="submit"><i class="fa fa-save"></i> Save</button>
                                    </div>
                                </div>
                            </form>
                        </div>

                    </div>

                </div>
            </div>
        </div>
    </div>
    <div class="row justify-content-md-center">
        <div class="col-lg-offset-2 col-lg-8">
            <div class="ibox ">
                <div class="ibox-title">
                    <h5>
                        Access level
                    </h5>
                    <div class="ibox-tools">
                        <a class="collapse-link">
                            <i class="fa fa-chevron-up"></i>
                        </a>
                    </div>
                </div>
                <div class="ibox-content">
                    <div class="row">
                        <div class="col-md-4">
                            <div id="nestable-menu">
                                <button type="button" data-action="expand-all" class="btn btn-white btn-sm">Expand all</button>
                                <button type="button" data-action="collapse-all" class="btn btn-white btn-sm">Collapse all</button>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-8">
                            <div class="dd" id="nestable2">
                                <ol class="dd-list">
                                    @Html.Raw(Model.RoleTreeView)
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts{

    <script src="~/js/jquery-3.1.1.min.js"></script>
    <script src="~/js/plugins/nestable/jquery.nestable.js"></script>
    <script src="~/js/plugins/metisMenu/jquery.metisMenu.js"></script>
    <script src="~/js/plugins/slimscroll/jquery.slimscroll.min.js"></script>

    <script>
        $(document).ready(function () {
            var ID_Elements = [];

            $('#nestable2').nestable({
                group: 1,
                maxDepth: 0,
            });

            $('#nestable-menu').on('click', function (e) {
                console.log(e);
                var target = $(e.target),
                    action = target.data('action');
                if (action === 'expand-all') {
                    $('.dd').nestable('expandAll');
                }
                if (action === 'collapse-all') {
                    $('.dd').nestable('collapseAll');
                }
            });

            $('.chkElements').on('change', function () {
                var yo = this.checked;
                //var modulos = $('input[data-parent=' + $(this).attr("id") + ']');
                //$.each(modulos, function (i, item) {
                //    item.checked = yo;
                //});
                Marcar($(this).attr("id"), yo);
                console.log(ID_Elements);
                $("#ID_Elements").val(JSON.stringify(ID_Elements));
            });

            function Marcar(id, value) {
                var modulos = $('input[data-parent=' + id + ']');
                if (value) {
                    ID_Elements.push(id);
                }
                else {
                    ID_Elements = jQuery.grep(ID_Elements, function (value) {
                        return value != id;
                    });
                }
                $.each(modulos, function (i, item) {
                    item.checked = value;

                    Marcar(item.id, value);
                });
            }
            var elementos = $('.chkElements');
            $.each(elementos, function (i, item) {
                if (item.checked) {
                    console.log(item);
                    ID_Elements.push(item.id);
                }
            });
            $("#ID_Elements").val(JSON.stringify(ID_Elements));

            //$('.chkModulos').change('change', function (e) {
            //    var yo = this.checked;
            //    var regla = $(this).parent('div.dd-handle').parent('li.dd-item').parent('ol.dd-list').parent('li.dd-item').children('div.dd-handle').children('.chkReglas');

            //    $.each(regla, function (i, item) {
            //        if (item.checked == false && yo == true)
            //            item.checked = true;
            //    });
            //});

            //$('.chkOperaciones').change('change', function (e) {
            //    var yo = this.checked;
            //    var modulo = $(this).parent('div.dd-handle').parent('li.dd-item').parent('ol.dd-list').parent('li.dd-item').children('div.dd-handle').children('.chkModulos');

            //    $.each(modulo, function (i, item) {
            //        if (item.checked == false && yo == true)
            //            item.checked = true;
            //    });
            //});

        });
    </script>
}